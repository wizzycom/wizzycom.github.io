---
layout: post
title: Mikrotik L2TP/IPsec VPN and android device as client
date: 2016-06-21 19:29:47.000000000 +03:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- How to
tags:
- Android
- Mikrotik
- VPN
meta:
  _edit_last: '1'
  ratings_users: '0'
  ratings_score: '0'
  ratings_average: '0'
author:
  login: wizzy
  email: wizzy@wizzycom.net
  display_name: wizzy
  first_name: ''
  last_name: ''
permalink: "/mikrotik-l2tpipsec-vpn-and-android-device-as-client/"
---
<p>Mikrotik should have<strong> a real internet IP</strong> to a certain interface. If it is located behind nat, the modem that provides internet access should be able to forward ipsec-esp packages. <strong>If your mikrotik is behind an internet modem that does not forward ipsec-esp, then you should stop here.</strong><br />
<!--more--></p>
<p>Your android smart phone must be in version 4 or newer in order to support <strong> L2TP/IPsec</strong>. The android client supports the following :</p>
<p>Authentication algorithm : sha1<br />
Encryption algorithm : 3des<br />
Diffie-Hellman : Group2 (modp1024)</p>
<p>Let's start by creating a PPP Profile on mikrotik.</p>
<pre>ppp profile add name=ipsec_vpn local-address=192.168.2.1 dns-server=8.8.8.8</pre>
<p>On local-address= we assing an IP address that will appear as the default gateway for the VPN clients. A good hint is to find a network that it is not used. Then we have to activate the L2TP server of the mikrotik and bind it with a PPP Profile.</p>
<pre>interface l2tp-server server set enabled=yes default-profile=ipsec_vpn authentication=mschap1,mschap2</pre>
<p>Once the the L2TP server is activated , we have to define the peering of IPSec and also the default ipsec policy. <strong>WARNING :</strong> On newer RouterOS versions,  <strong>generate-policy</strong> set to <strong>yes </strong>is not supported. On this case just use <strong>generate-policy=port-override</strong></p>
<p>Older :</p>
<pre>/ip ipsec policy set [ find default=yes ] src-address=0.0.0.0/0 dst-address=0.0.0.0/0 protocol=all proposal=default template=yes
/ip ipsec peer add address=0.0.0.0/0 port=500 auth-method=pre-shared-key secret=123456 exchange-mode=main-l2tp send-initial-contact=no nat-traversal=yes proposal-check=obey hash-algorithm=sha1 enc-algorithm=3des dh-group=modp1024 generate-policy=yes</pre>
<p>Newer :</p>
<pre>/ip ipsec policy set [ find default=yes ] src-address=0.0.0.0/0 dst-address=0.0.0.0/0 protocol=all proposal=default template=yes
/ip ipsec peer add address=0.0.0.0/0 port=500 auth-method=pre-shared-key secret=123456 exchange-mode=main-l2tp send-initial-contact=no nat-traversal=yes proposal-check=obey hash-algorithm=sha1 enc-algorithm=3des dh-group=modp1024 generate-policy=port-override</pre>
<p>On secret = you should define the pre-shared key that must match the pre-shared key of the client (android phone). After we defined the peering, we must make some changes on the default ipsec proposal.</p>
<pre>ip ipsec proposal set default auth-algorithms=sha1 enc-algorithms=3des pfs-group=modp1024</pre>
<p>To complete the configuration, we need to add a user.</p>
<pre>ppp secret add name=user password=pass service=l2tp profile=ipsec_vpn remote-address=192.168.2.2</pre>
<p>On <strong>user=</strong> we define the user name and the user password on password=. On remote-address= we define the desired IP address that will be assigned to the client.</p>
<p>Next steps :</p>
<p>If our mikrotik has real internet IP to an interface and we have enabled firewalling, we must allow the UDP ports : 500, UDP: 1701, UDP: 4500 and Protocol 50: ipsec-esp</p>
<p>For the android client, we must set the following :</p>
<p>Name : Home VPN<br />
Type : L2TP/IPSec PSK<br />
Server address : real ip address of mikrotik<br />
IPSec pre-shared key : the value that you set as secret=</p>
<p>Good luck.</p>
<p>[ratings]</p>
