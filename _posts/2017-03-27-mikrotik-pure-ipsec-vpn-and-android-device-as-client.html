---
layout: post
title: Mikrotik pure IPsec VPN and android device as client
date: 2017-03-27 19:14:52.000000000 +03:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- How to
tags:
- Android
- Mikrotik
- VPN
meta:
  _edit_last: '1'
  ratings_users: '0'
  ratings_score: '0'
  ratings_average: '0'
author:
  login: wizzy
  email: wizzy@wizzycom.net
  display_name: wizzy
  first_name: ''
  last_name: ''
permalink: "/mikrotik-pure-ipsec-vpn-and-android-device-as-client/"
---
<p><strong>Due to issues reported, I had to re-write this guide. This time all certificates are generated by mikrotik routerboard. I use openssl just to create the .p12 personal information exchange file for the android client.</strong></p>
<p>Mikrotik routerOS used : <strong>6.41.1</strong><br />
Android version used : <strong>7</strong></p>
<p><span style="font-size: 1rem;">First we have to create some SSL certificates. A CA, a server certificate and a client certificate. Let's start with the CA. <strong>Replace XX and xxxxxx with your information</strong> :</span></p>
<pre>/certificate
add name=ca-template common-name=myCa key-usage=key-cert-sign,crl-sign days-valid=3650 key-size=2048 country=<strong><span style="color: #ff0000;">XX</span></strong> state=<span style="color: #ff0000;"><strong>xxxxxx</strong></span> locality=<span style="color: #ff0000;"><strong>xxxxxx</strong></span> organization=<span style="color: #ff0000;"><strong>xxxxxx</strong></span> unit="Certificate Authority"
sign ca-template name=myCa
set myCa trusted=yes</pre>
<p><!--more-->Then we create and sign the server certificate. <span style="font-size: 1rem;"><strong>Replace XX and xxxxxx with your information</strong> :</span></p>
<pre>/certificate
add name=server-template common-name=server days-valid=3650 key-size=2048 country=<strong><span style="color: #ff0000;">XX</span></strong> state=<span style="color: #ff0000;"><strong>xxxxxx</strong></span> locality=<span style="color: #ff0000;"><strong>xxxxxx</strong></span> organization=<span style="color: #ff0000;"><strong>xxxxxx</strong></span> unit="Services" 
sign server-template ca=myCa name=server
set server trusted=yes</pre>
<p>And the client certificate. <span style="font-size: 1rem;"><strong>Replace XX and xxxxxx with your information</strong> :</span></p>
<pre>/certificate
add name=client1-template common-name=client days-valid=3650 key-size=2048 country=<strong><span style="color: #ff0000;">XX</span></strong> state=<span style="color: #ff0000;"><strong>xxxxxx</strong></span> locality=<span style="color: #ff0000;"><strong>xxxxxx</strong></span> organization=<span style="color: #ff0000;"><strong>xxxxxx</strong></span> unit="Services" 
sign client1-template ca=myCa name=client1</pre>
<p>For the android certificates we are going to create a p12 certificate file. To to this we are going to use openssl on a linux box, but first, we have to export the files needed from routerOS. The files needed are :</p>
<ul>
<li>the authority certificate file</li>
<li>the client1 certificate and key file (we need to set a password at least 8 characters long)</li>
</ul>
<pre>/certificate export-certificate myCa
/certificate export-certificate client1 export-passphrase=<span style="color: #ff0000;"><strong>xxxxxxxx</strong></span></pre>
<p>The files below will be exported in <strong>/Files</strong> :</p>
<ul>
<li>cert_export_client1.crt</li>
<li>cert_export_client1.key</li>
<li>cert_export_myCa.crt</li>
</ul>
<p>We then move these files on the linux box and we issue the following command to create the .p12 personal information exchange file</p>
<pre>openssl pkcs12 -export -in cert_export_client1.crt -inkey cert_export_client1.key -certfile cert_export_myCa.crt -name client1 -out client1.p12</pre>
<p>&nbsp;</p>
<p>After that, we upload <strong>client1.p12</strong> and<strong> cert_export_myCa.crt</strong> to your android device and just select it from your file manager. First select to import the <strong>cert_export_myCa.crt </strong>file and then file <strong>client1.p12</strong><strong>. </strong>When <strong>cert_export_myCa.crt</strong>  is imported, android will ask for a name. Just named is <strong>myCA</strong>.</p>
<p>Now lets configure our mikrotik. First we are going to create an address pool for the vpn client :</p>
<pre>/ip pool
 add name=pool_vpn ranges=192.168.1.2-192.168.1.10</pre>
<p>Then it's IPSec.</p>
<pre>/ip ipsec mode-config
 add address-pool=pool_vpn address-prefix-length=32 name=vpn split-include=10.0.0.0/8 system-dns=no</pre>
<p>On split-include you must define the networks that the client can access. I just used 10.0.0.0/8. Now lets proceed with the IPSec peers :</p>
<pre>/ip ipsec peer
 add address=0.0.0.0/0 auth-method=rsa-signature certificate=server dh-group=modp2048 enc-algorithm=aes-256 exchange-mode=ike2 generate-policy=port-strict hash-algorithm=sha256 mode-config=vpn passive=yes</pre>
<p>Last but not least, out proposal and our policy :</p>
<pre>/ip ipsec proposal
 set [ find default=yes ] auth-algorithms=sha256 pfs-group=none enc-algorithms=aes-256-cbc
 /ip ipsec policy
 set 0 dst-address=192.168.1.0/24 src-address=10.0.0.0/8</pre>
<p>As you can see, our IPSec policy matches the "interesting" traffic. Traffic that must be encrypted or decrypted.</p>
<p>If you have a firewall configured, the you must allow UDP 500, UDP 4500 and ESP  :</p>
<pre>add action=accept chain=input dst-port=500,4500 in-interface=internet protocol=udp
add action=accept chain=input in-interface=internet protocol=ipsec-esp</pre>
<p>This is all we have to configure on mikrotik. On our android device we have to create a new VPN with the following options :</p>
<p><strong>Name</strong> : Whatever pleases you<br />
<strong>Type</strong> : IPSec IKEv2 RSA<br />
<strong>Server address</strong> : Your public ip address<br />
<strong>IPSec user certificate</strong> : Choose client1 ( if you see only the option unspecified then the certs are not imported )<br />
<strong>IPSec CA certificate</strong> :  Choose myCA<br />
<strong>IPSec server certificate</strong> : Received from server<br />
<strong>DNS server</strong> : The IP of your local DNS server<br />
<strong>Forwarding routes</strong> : The net you need to access. My exaple is 10.0.0.0/8</p>
<p>Press save and try it!</p>
<p>Good luck.</p>
<p>[ratings]</p>
